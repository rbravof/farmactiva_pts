{% extends "base_carrier.html" %}
{% block title %}Mis envÃ­os{% endblock %}
{% block content %}
<main class="page">
  <div class="wrap">
    <div class="flex items-center justify-between gap-3 mb-3">
      <h1 class="text-xl font-semibold">Mis envÃ­os recientes</h1>

      <!-- Acciones de ruta -->
      <div class="flex items-center gap-2">
        <button id="btnSelectAll" class="px-3 py-2 rounded-xl border hover:bg-gray-50 text-sm hidden md:inline">
          Seleccionar todo
        </button>
        <button id="btnClearSel" class="px-3 py-2 rounded-xl border hover:bg-gray-50 text-sm hidden md:inline">
          Limpiar
        </button>
        <button id="btnRuta" class="px-3 py-2 rounded-xl border hover:bg-gray-50">
          Crear ruta eficiente
        </button>
      </div>
    </div>

    {% set lst = pedidos or rows %}
    <ul class="space-y-3">
      {% for r in lst %}
      <li class="p-4 rounded-2xl border">
        <div class="flex items-start gap-3">
          <!-- checkbox selecciÃ³n -->
          <input type="checkbox"
                 class="mt-1 h-5 w-5 flex-shrink-0 pedido-check"
                 value="{{ r.id_pedido }}"
                 aria-label="Seleccionar pedido {{ r.numero }}">

          <!-- contenido -->
          <div class="min-w-0 flex-1">
            <div class="flex items-start justify-between gap-3">
              <div class="min-w-0">
                <div class="font-semibold truncate">#{{ r.numero }} â€” {{ r.cliente_nombre }}</div>
                <div class="text-sm text-gray-600 truncate">
                  {{ r.calle }} {{ r.calle_numero }} {{ r.depto or '' }}
                  {% if r.comuna %}, {{ r.comuna }}{% endif %}
                  {% if r.region %}, {{ r.region }}{% endif %}
                </div>
                <div class="mt-1 text-xs text-gray-500">
                  Estado: <span class="font-medium">{{ r.estado_nombre }}</span>
                  {% if r.estado_logistico %} Â· Log: {{ r.estado_logistico }}{% endif %}
                </div>
              </div>

              <!-- abrir detalle -->
              <a class="px-3 py-2 rounded-xl border hover:bg-gray-50 whitespace-nowrap"
                 href="/carrier/pedidos/{{ r.id_pedido }}">Abrir</a>
            </div>
          </div>
        </div>
      </li>
      {% else %}
      <li class="text-gray-500">No tienes envÃ­os asignados.</li>
      {% endfor %}
    </ul>

    <div class="mt-4">
      <a href="/carrier" class="text-blue-600 hover:underline">Ver todos</a>
    </div>
  </div>
</main>

<script>
  (function () {
    const $$ = (q) => Array.from(document.querySelectorAll(q));
    const btnRuta = document.getElementById('btnRuta');
    const btnAll  = document.getElementById('btnSelectAll');
    const btnClr  = document.getElementById('btnClearSel');

    function getSelectedIds() {
      return $$('.pedido-check').filter(c => c.checked).map(c => c.value);
    }
    function anyCheckbox() {
      return $$('.pedido-check').length > 0;
    }

    // Mostrar/ocultar helpers segÃºn haya pedidos
    if (!anyCheckbox()) {
      if (btnAll) btnAll.style.display = 'none';
      if (btnClr) btnClr.style.display = 'none';
    } else {
      if (btnAll) btnAll.classList.remove('hidden');
      if (btnClr) btnClr.classList.remove('hidden');
    }

    if (btnAll) btnAll.onclick = () => {
      $$('.pedido-check').forEach(c => c.checked = true);
    };
    if (btnClr) btnClr.onclick = () => {
      $$('.pedido-check').forEach(c => c.checked = false);
    };

    if (btnRuta) {
      btnRuta.onclick = async () => {
        const ids = getSelectedIds();
        if (!ids.length) {
          alert('Selecciona al menos un pedido para crear la ruta.');
          return;
        }
        const url = '/carrier/ruta?ids=' + encodeURIComponent(ids.join(','));
        console.log('ðŸ§­ [CARRIER/LIST] solicitar ruta ->', url);

        try {
          const res = await fetch(url, { method: 'GET' });
          if (!res.ok) throw new Error('HTTP ' + res.status);
          const j = await res.json();
          if (!j.ok || !j.gmaps_url) {
            alert('No se pudo generar la ruta.');
            return;
          }
          // Abre Google Maps. Si el navegador bloquea popups, fallback a redirecciÃ³n misma pestaÃ±a.
          const win = window.open(j.gmaps_url, '_blank');
          if (!win) window.location.href = j.gmaps_url;
        } catch (e) {
          console.error('ðŸ’¥ [CARRIER/LIST] error creando ruta:', e);
          alert('Error creando la ruta.');
        }
      };
    }
  })();
</script>
{% endblock %}
