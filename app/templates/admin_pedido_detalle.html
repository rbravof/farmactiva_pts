{% extends "base_admin.html" %}
{% block title %}Pedido #{{ header.numero or header.id_pedido }}{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto p-6 space-y-4">

  <!-- Volver -->
  <a href="/admin/pedidos" class="text-sm text-slate-600 hover:underline">Volver</a>

  <style>
    /* Refuerzo para evitar overrides que lo dejen ‚Äúblanco‚Äù */
    #btn-save-estado {
      background-color: #059669 !important;   /* emerald-600 */
      border-color:     #047857 !important;   /* emerald-700 */
      color: #fff !important;
    }
    #btn-save-estado:hover {
      background-color: #047857 !important;   /* emerald-700 */
    }
    #btn-save-estado[disabled]{
      background-color: #10b981 !important;   /* emerald-500 */
      border-color:     #059669 !important;   /* emerald-600 */
      opacity: .85;
      cursor: not-allowed;
    }
      /* Anti-override: evita que otros estilos de botones lo dejen blanco */
    #btn-pay-manual{
      background-color:#059669 !important;  /* emerald-600 */
      border-color:#047857 !important;      /* emerald-700 */
      color:#fff !important;
    }
    #btn-pay-manual:hover{ background-color:#047857 !important; }
  </style>

  <!-- Encabezado tipo Shopify -->
  <div class="flex flex-wrap items-center justify-between gap-3">
    <div class="space-y-1">
      <h1 class="text-2xl font-semibold">#{{ header.numero or header.id_pedido }}</h1>
      <div class="text-sm text-slate-500">
        {{ header.creado_en or '' }} ¬∑ {{ header.canal or 'Online' }}
      </div>
      <div class="flex gap-2 mt-1">
        {% set pago_ok = ((header.get('pago_estado') or '')|lower in ['pagado','paid','approved']) %}
        <span class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium
                     {{ 'bg-emerald-50 text-emerald-700 border border-emerald-200' if pago_ok else 'bg-amber-50 text-amber-700 border border-amber-200' }}">
          {{ 'Pagado' if pago_ok else 'No pagado' }}
        </span>
        {% set estado_code = (header.get('estado_codigo') or 'NUEVO') %}
        {% set estado_name = (header.get('estado_nombre') or estado_code.replace('_',' ')|title) %}
        <span id="badge-estado"
              data-estado="{{ estado_code }}"
              class="inline-flex items-center rounded-full px-2.5 py-0.5 text-xs font-medium
                    border bg-green-50 text-green-700 border-green-200"
              style="background-color:#ECFDF5; color:#166534; border-color:#BBF7D0;">
          {{ estado_name }}
        </span>
      </div>
    </div>

    <div class="flex flex-wrap gap-2 items-center">
      <button class="px-3 py-2 border rounded-lg text-slate-700 cursor-not-allowed opacity-60" disabled>Reembolsar</button>
      <button class="px-3 py-2 border rounded-lg text-slate-700 cursor-not-allowed opacity-60" disabled>Editar</button>

      <!-- Men√∫: M√°s acciones -->
      <div class="relative overflow-visible" id="actions-dropdown">
        <button type="button" id="btn-more-actions" aria-expanded="false"
                class="px-3 py-2 rounded-lg border bg-white hover:bg-slate-50 text-slate-800">
          M√°s acciones ‚ñæ
        </button>
        <div id="menu-more-actions"
            class="hidden absolute right-0 mt-2 w-56 bg-white border rounded-xl shadow-lg z-50">
          <button type="button" id="act-imprimir"
                  class="w-full text-left px-3 py-2 hover:bg-slate-50">Imprimir Etiqueta</button>
          <button type="button" id="act-estado"
                  class="w-full text-left px-3 py-2 hover:bg-slate-50">Cambiar Estado</button>
          <!-- Bot√≥n en la barra de acciones del detalle -->
          <button type="button"
                  class="btn btn-mint px-3 py-2 rounded-xl"
                  onclick="document.getElementById('modalAsignarTransportista').showModal()">
            üöö Asignar transportista
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Grid principal: 8/4 -->
  <div class="grid grid-cols-1 md:grid-cols-12 gap-6">

    <!-- Columna izquierda -->
    <div class="md:col-span-8 space-y-6">

      {# --- √çtems del pedido --- #}
      <section class="bg-white border rounded-xl">
        <div class="px-5 py-3 border-b">
          <h2 class="font-medium">Art√≠culos</h2>
        </div>

        <div class="p-5 overflow-x-auto">
          <table class="w-full text-sm">
            <thead>
              <tr class="text-left text-slate-600">
                <th class="py-2">Art√≠culo</th>
                <th class="py-2 w-24 text-right">Precio</th>
                <th class="py-2 w-16 text-right">Cant.</th>
                <th class="py-2 w-28 text-right">Subtotal</th>
              </tr>
            </thead>
            <tbody>
              {% set ns = namespace(subtotal=0) %}
              {% for it in items %}
                {% set ns.subtotal = ns.subtotal + (it.subtotal or 0) %}
                <tr class="border-t align-top">
                  <td class="py-3">
                    <div class="flex gap-3">
                      <img src="{{ it.imagen_principal_url or '/static/images/placeholder.png' }}"
                          alt="" class="w-12 h-12 rounded border object-cover">
                      <div>
                        <div class="font-medium text-slate-800">
                          {{ it.display_nombre_producto or ('Producto #' ~ it.id_producto) }}
                        </div>
                        <div class="text-xs text-slate-500">ID {{ it.id_producto }}</div>
                      </div>
                    </div>
                  </td>
                  <td class="py-3 text-right">{{ (it.precio_unitario or 0) | int }}</td>
                  <td class="py-3 text-right">{{ it.cantidad or 1 }}</td>
                  <td class="py-3 text-right">{{ (it.subtotal or 0) | int }}</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>

          <!-- Totales -->
          <div class="mt-4 flex flex-col items-end gap-1 text-sm">
            <div class="flex justify-end w-full max-w-sm">
              <span class="flex-1 text-right pr-4 text-slate-600">Subtotal art√≠culos</span>
              <span class="w-32 text-right">{{ ns.subtotal | int }}</span>
            </div>
            <div class="flex justify-end w-full max-w-sm">
              <span class="flex-1 text-right pr-4 text-slate-600">Env√≠o</span>
              <span class="w-32 text-right">{{ (header.costo_envio or 0) | int }}</span>
            </div>
            <div class="flex justify-end w-full max-w-sm font-semibold">
              <span class="flex-1 text-right pr-4">Total</span>
              <span class="w-32 text-right">{{ (header.total_neto or (ns.subtotal + (header.costo_envio or 0))) | int }}</span>
            </div>
          </div>
        </div>
      </section>

      <!-- Pago -->
      <section class="bg-white border rounded-xl">
        <div class="px-5 py-3 border-b flex items-center justify-between">
          <h2 class="font-medium">Pago</h2>

          {% set _pago_estado = (header.get('pago_estado') or '')|lower %}
          {% set is_paid = _pago_estado in ['pagado','paid','approved'] %}
          {% if not is_paid %}
            <div class="flex gap-2">
              <button id="btn-pay-email"
                      type="button"
                      class="px-3 py-2 rounded-lg border bg-white hover:bg-slate-50 text-slate-800">
                Solicitar pago por correo
              </button>
              <!-- üëá bot√≥n verde con refuerzo anti-override -->
              <button id="btn-pay-manual"
                      type="button"
                      class="px-3 py-2 rounded-lg text-white bg-emerald-600 hover:bg-emerald-700
                            border border-emerald-700 shadow-sm hover:shadow"
                      style="background-color:#059669; border-color:#047857; color:#ffffff;">
                Marcar como pagado
              </button>
            </div>
          {% endif %}
        </div>

        <div class="p-5 space-y-3 text-sm">
          <div class="flex justify-between">
            <span class="text-slate-600">Estado</span>
            <span class="font-medium">{{ header.get('pago_estado') or '‚Äî' }}</span>
          </div>
          <div class="flex justify-between">
            <span class="text-slate-600">Proveedor</span>
            <span class="font-medium">{{ header.get('pago_proveedor') or '‚Äî' }}</span>
          </div>

          {% set _pago_monto  = header.get('pago_monto') %}
          {% set _total_neto  = header.get('total_neto') %}
          {% set _pago_moneda = header.get('pago_moneda') or 'CLP' %}

          <div class="flex justify-between">
            <span class="text-slate-600">Monto</span>
            <span class="font-medium">
              {{ (_pago_monto if _pago_monto is not none else (_total_neto or 0)) | int }}
              {{ _pago_moneda }}
            </span>
          </div>
        </div>
      </section>

      <!-- Env√≠o -->
      <section class="bg-white border rounded-xl">
        <div class="px-5 py-3 border-b">
          <h2 class="font-medium">Env√≠o</h2>
        </div>

        <div class="p-5 text-sm space-y-3">
          <div class="flex justify-between">
            <span class="text-slate-600">Tipo de env√≠o</span>
            <span class="font-medium">{{ header.tipo_envio_nombre or header.id_tipo_envio or '‚Äî' }}</span>
          </div>
          <div class="flex justify-between">
            <span class="text-slate-600">Costo</span>
            <span class="font-medium">
              {{ header.costo_envio if header.costo_envio is not none else '‚Äî' }}
            </span>
          </div>

          <div class="border-t pt-3"></div>

          {% if envio_dir %}
            {% set line1 = (envio_dir.calle ~ ' ' ~ (envio_dir.numero or ''))|trim %}
            {% set line2 = envio_dir.depto %}
            {% set line3 = ((envio_dir.comuna or '') ~ (', ' if envio_dir.comuna and envio_dir.ciudad else '') ~ (envio_dir.ciudad or ''))|trim %}
            {% set line4 = ((envio_dir.region or '') ~ ' ' ~ (envio_dir.codigo_postal or ''))|trim %}

            <div class="space-y-0.5">
              <div class="font-medium">{{ envio_dir.nombre or header.cliente_nombre }}</div>
              {% if line1 %}<div>{{ line1 }}</div>{% endif %}
              {% if line2 %}<div>{{ line2 }}</div>{% endif %}
              {% if line3 %}<div>{{ line3 }}</div>{% endif %}
              {% if line4 %}<div>{{ line4 }}</div>{% endif %}
              <div>{{ envio_dir.pais or 'Chile' }}</div>
              {% if envio_dir.telefono %}<div>Tel: {{ envio_dir.telefono }}</div>{% endif %}
            </div>

            {% set q = (line1 ~ ', ' ~ line3 ~ ', ' ~ (envio_dir.region or '') )|replace(' ', '+') %}
            <a class="inline-block mt-2 text-sky-700 hover:underline"
              href="https://www.google.com/maps/search/?api=1&query={{ q }}"
              target="_blank" rel="noreferrer">Ver mapa</a>
          {% else %}
            <div class="text-slate-500">Sin direcci√≥n registrada.</div>
          {% endif %}
        </div>
      </section>

      <section class="mt-6 p-4 border rounded-2xl">
        <h4 class="font-medium mb-2">Env√≠o</h4>
        {% if carrier.transportista_nombre %}
          <p><strong>Transportista:</strong> {{ carrier.transportista_nombre }}</p>
          {% if carrier.tracking_ext %}
            <p><strong>Tracking:</strong> <a class="text-blue-600 underline" href="{{ carrier.tracking_ext }}" target="_blank">{{ carrier.tracking_ext }}</a></p>
          {% endif %}
          <p><strong>Estado log√≠stico:</strong> {{ carrier.estado_logistico }}</p>
        {% else %}
          <p class="text-gray-500">No asignado</p>
        {% endif %}

        <div class="mt-4">
          <h5 class="font-medium mb-1">Traza log√≠stica</h5>
          <ul class="space-y-1 text-sm">
            {% for ev in eventos_envio %}
              <li>‚Ä¢ <span class="font-semibold">{{ ev.estado }}</span> ‚Äî {{ ev.nota or '' }} <span class="text-gray-500">({{ ev.creado_en }}, {{ ev.actor }} {{ ev.actor_usuario or '' }})</span></li>
            {% else %}
              <li class="text-gray-500">Sin eventos</li>
            {% endfor %}
          </ul>
        </div>
      </section>

      <!-- Cronolog√≠a (placeholder) -->
      <section class="bg-white border rounded-xl">
        <div class="px-5 py-3 border-b">
          <h2 class="font-medium">Cronolog√≠a</h2>
        </div>
        <div class="p-5 space-y-3">
          <div class="text-sm text-slate-500">A√∫n no hay notas.</div>
          <div class="flex gap-2">
            <textarea class="flex-1 border rounded-lg px-3 py-2" placeholder="Deja un comentario‚Ä¶" disabled></textarea>
            <button class="px-3 py-2 border rounded-lg text-slate-700 cursor-not-allowed opacity-60" disabled>
              Publicar
            </button>
          </div>
        </div>
      </section>

    </div>

    <!-- Columna derecha -->
    <aside class="md:col-span-4 space-y-6">

      <!-- Cliente -->
      <section class="bg-white border rounded-xl">
        <div class="px-5 py-3 border-b">
          <h3 class="font-medium">Cliente</h3>
        </div>
        <div class="p-5 text-sm space-y-2">
          <div class="font-medium text-slate-800">{{ header.cliente_nombre or '‚Äî' }}</div>
          <div class="text-slate-600">{{ header.cliente_email or '‚Äî' }}</div>
          <div class="text-slate-600">{{ header.cliente_telefono or '‚Äî' }}</div>
        </div>
      </section>

      <!-- Direcci√≥n de env√≠o -->
      <section class="bg-white border rounded-xl">
        <div class="px-5 py-3 border-b">
          <h3 class="font-medium">Direcci√≥n de env√≠o</h3>
        </div>

        <div class="p-5 text-sm text-slate-700 space-y-2">
          {% if envio_dir %}
            {% set line1 = (envio_dir.calle ~ ' ' ~ (envio_dir.numero or ''))|trim %}
            {% set line2 = envio_dir.depto %}
            {% set line3 = ((envio_dir.comuna or '') ~ (', ' if envio_dir.comuna and envio_dir.ciudad else '') ~ (envio_dir.ciudad or ''))|trim %}
            {% set line4 = ((envio_dir.region or '') ~ ' ' ~ (envio_dir.codigo_postal or ''))|trim %}

            <div class="font-medium">{{ envio_dir.nombre or header.cliente_nombre }}</div>
            {% if line1 %}<div>{{ line1 }}</div>{% endif %}
            {% if line2 %}<div>{{ line2 }}</div>{% endif %}
            {% if line3 %}<div>{{ line3 }}</div>{% endif %}
            {% if line4 %}<div>{{ line4 }}</div>{% endif %}
            <div>{{ envio_dir.pais or 'Chile' }}</div>
            {% if envio_dir.telefono %}<div>Tel: {{ envio_dir.telefono }}</div>{% endif %}

            {% set q = (line1 ~ ', ' ~ line3 ~ ', ' ~ (envio_dir.region or '')) | replace(' ', '+') %}
            <a class="inline-block mt-2 text-sky-700 hover:underline"
              href="https://www.google.com/maps/search/?api=1&query={{ q }}"
              target="_blank" rel="noreferrer">Ver mapa</a>
          {% else %}
            <div class="text-slate-500">Sin direcci√≥n registrada.</div>
          {% endif %}
        </div>
      </section>

      <!-- Direcci√≥n de facturaci√≥n -->
      <section class="bg-white border rounded-xl">
        <div class="px-5 py-3 border-b">
          <h3 class="font-medium">Direcci√≥n de facturaci√≥n</h3>
        </div>

        <div class="p-5 text-sm text-slate-700 space-y-2">
          {% set _fact = fact_dir or envio_dir %}
          {% if _fact %}
            {% set f1 = (_fact.calle ~ ' ' ~ (_fact.numero or ''))|trim %}
            {% set f2 = _fact.depto %}
            {% set f3 = ((_fact.comuna or '') ~ (', ' if _fact.comuna and _fact.ciudad else '') ~ (_fact.ciudad or ''))|trim %}
            {% set f4 = ((_fact.region or '') ~ ' ' ~ (_fact.codigo_postal or ''))|trim %}

            <div class="font-medium">{{ _fact.nombre or header.cliente_nombre }}</div>
            {% if f1 %}<div>{{ f1 }}</div>{% endif %}
            {% if f2 %}<div>{{ f2 }}</div>{% endif %}
            {% if f3 %}<div>{{ f3 }}</div>{% endif %}
            {% if f4 %}<div>{{ f4 }}</div>{% endif %}
            <div>{{ _fact.pais or 'Chile' }}</div>
            {% if _fact.telefono %}<div>Tel: {{ _fact.telefono }}</div>{% endif %}
          {% else %}
            <div class="text-slate-500">Sin direcci√≥n registrada.</div>
          {% endif %}
        </div>
      </section>
      
      <!-- Etiquetas (placeholder) -->
      <section class="bg-white border rounded-xl">
        <div class="px-5 py-3 border-b">
          <h3 class="font-medium">Etiquetas</h3>
        </div>
        <div class="p-5">
          <input class="w-full border rounded-lg px-3 py-2 text-sm opacity-60" placeholder="Agregar etiqueta‚Ä¶" disabled>
        </div>
      </section>

      <!-- Historial & Notas -->
      <section class="bg-white border rounded-xl">
        <div class="px-5 py-3 border-b flex items-center justify-between">
          <h3 class="font-medium">Historial y notas</h3>
          <span class="text-xs px-2 py-1 rounded-full bg-slate-100 text-slate-700">{{ notas|length }}</span>
        </div>

        <form method="post" action="/admin/pedidos/{{ header.id_pedido }}/notas/nueva" class="p-5 space-y-3">
          <textarea name="texto" rows="3" class="w-full border rounded-lg px-3 py-2 text-sm"
                    placeholder="Escribe una nota para el equipo o para el cliente‚Ä¶" required></textarea>

          <div class="flex items-center gap-3 text-sm">
            <label class="inline-flex items-center gap-2">
              <input type="radio" name="audiencia" value="interno" checked>
              <span>Interna (solo equipo)</span>
            </label>
            <label class="inline-flex items-center gap-2">
              <input type="radio" name="audiencia" value="cliente">
              <span>Visible al cliente</span>
            </label>

            <select name="destinatario_rol" id="sel-destinatario"
                    class="w-full border rounded-lg px-3 py-2">
              <option value="">‚Äî Selecciona rol (opcional) ‚Äî</option>
              {% for r in roles_combo %}
                <option value="{{ r.code }}" {{ 'selected' if default_dest == r.code else '' }}>
                  {{ r.name }}
                </option>
              {% endfor %}
            </select>

          </div>

          <div class="flex items-center justify-end">
            <button class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-900 text-white text-sm">
              Agregar nota
            </button>
          </div>
        </form>

        <div class="px-5 pb-5 space-y-4">
          {% if notas and notas|length > 0 %}
            {% for n in notas %}
              <div class="flex items-start gap-3">
                <div class="mt-1 w-2 h-2 rounded-full {{ 'bg-emerald-500' if n.audiencia=='cliente' else 'bg-slate-300' }}"></div>
                <div class="flex-1">
                  <div class="text-xs text-slate-500">
                    {{ n.creado_en }} ¬∑
                    {{ n.autor_nombre or '‚Äî' }}
                    {% if n.autor_rol %}¬∑ {{ n.autor_rol }}{% endif %}
                    {% if n.destinatario_rol %} ¬∑ ‚Üí {{ n.destinatario_rol }}{% endif %}
                    {% if n.audiencia == 'cliente' %}
                      <span class="ml-1 inline-flex items-center text-emerald-700 bg-emerald-50 border border-emerald-100 rounded px-1.5 py-0.5">Cliente</span>
                    {% else %}
                      <span class="ml-1 inline-flex items-center text-slate-700 bg-slate-50 border border-slate-200 rounded px-1.5 py-0.5">Interno</span>
                    {% endif %}
                  </div>
                  <div class="mt-1 text-sm text-slate-800 whitespace-pre-line">{{ n.texto }}</div>
                </div>
              </div>
            {% endfor %}
          {% else %}
            <div class="text-sm text-slate-500">Sin notas a√∫n.</div>
          {% endif %}
        </div>
      </section>
    </aside>
  </div>
</div>

<!-- Modal: Imprimir Etiqueta -->
<div id="modal-label" class="hidden fixed inset-0 z-40">
  <div class="absolute inset-0 bg-black/40" data-close="label"></div>
  <div class="absolute inset-0 grid place-items-center p-4">
    <!-- ancho del modal generoso para evitar scroll -->
    <div class="max-w-full bg-white rounded-2xl shadow-xl border" style="width: 120mm;">
      <div class="px-4 py-3 border-b flex items-center justify-between">
        <h3 class="font-medium">Etiqueta de env√≠o</h3>
        <div class="flex items-center gap-2">
          <button id="btn-print-label"
                  class="px-3 py-1.5 rounded-lg border bg-white hover:bg-slate-50">Imprimir</button>
          <button class="px-3 py-1.5 rounded-lg border bg-white hover:bg-slate-50" data-close="label">Cerrar</button>
        </div>
      </div>
      <div class="p-3">
        <!-- Viewport del iframe amplio; el documento interno se autoescala en pantalla -->
        <iframe id="label-frame"
                src=""
                class="block bg-white rounded-lg"
                style="width: 106mm; height: 80mm; border: 1px solid #e5e7eb;"></iframe>
      </div>
    </div>
  </div>
</div>

<!-- Modal: Cambiar Estado -->
<div id="modal-estado" class="hidden fixed inset-0 z-40">
  <div class="absolute inset-0 bg-black/40" data-close="estado"></div>
  <div class="absolute inset-0 grid place-items-center p-4">
    <div class="w-[560px] max-w-full bg-white rounded-2xl shadow-xl border">
      <div class="px-4 py-3 border-b flex items-center justify-between">
        <h3 class="font-medium">Cambiar estado del pedido</h3>
        <button class="px-3 py-1.5 rounded-lg border bg-white hover:bg-slate-50" data-close="estado">Cerrar</button>
      </div>

      <form id="form-estado" class="p-4 space-y-4">
        <!-- Fila 1: Rol destinatario + Nuevo estado -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">          
          <div>
            {% if estados and estados|length > 0 %}
              <label class="block text-sm text-slate-700 mb-1">Nuevo estado</label>
              <select name="nuevo_estado" class="w-full border rounded-lg px-3 py-2">
                {% for e in estados %}
                  <option value="{{ e.codigo }}" {{ 'selected' if loop.first else '' }}>
                    {{ e.nombre or (e.codigo | replace('_',' ') | title) }}
                  </option>
                {% endfor %}
              </select>
            {% else %}
              <label class="block text-sm text-slate-700 mb-1">Nuevo estado (c√≥digo)</label>
              <input name="nuevo_estado" required class="w-full border rounded-lg px-3 py-2" placeholder="ej: APROBADO_QF">
            {% endif %}
          </div>
          
          <div>
            <label class="block text-sm text-slate-700 mb-1">Rol destinatario</label>
            <select name="destinatario_rol" class="w-full border rounded-lg px-3 py-2">
              <option value="">‚Äî Selecciona rol (opcional) ‚Äî</option>
              <option value="bodega">Bodega</option>
              <option value="ventas">Ventas</option>
              <option value="reparto">Reparto</option>
            </select>
          </div>
        </div>

        <!-- Fila 2: Notas (cliente / rol) -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
          <div>
            <label class="block text-sm text-slate-700 mb-1">Nota para el cliente (opcional)</label>
            <textarea name="nota_cliente" rows="3" class="w-full border rounded-lg px-3 py-2 text-sm" placeholder="Mensaje visible al cliente‚Ä¶"></textarea>
          </div>
          <div>
            <label class="block text-sm text-slate-700 mb-1">Nota interna para el rol (opcional)</label>
            <textarea name="nota_rol" rows="3" class="w-full border rounded-lg px-3 py-2 text-sm" placeholder="Instrucciones para bodega/reparto/ventas‚Ä¶"></textarea>
          </div>
        </div>

        <!-- Footer del modal -->
        <div class="flex items-center justify-end gap-2 pt-2">
          <button type="button"
                  data-close="estado"
                  class="px-3 py-2 rounded-lg border bg-white hover:bg-slate-50">
            Cancelar
          </button>

          <!-- üëá Bot√≥n de Guardar -->
          <button
            id="btn-save-estado"
            type="submit"
            class="px-3 py-2 rounded-lg text-white bg-emerald-600 hover:bg-emerald-700
                  border border-emerald-700 shadow-sm hover:shadow
                  focus:outline-none focus:ring-2 focus:ring-emerald-500 focus:ring-offset-1">
            Guardar estado
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Safelist anti-purge: mantenemos las clases que se aplican din√°micamente v√≠a JS -->
<div class="hidden">
  <span class="bg-green-50 text-green-700 border-green-200"></span>
  <span class="bg-sky-50 text-sky-700 border-sky-200"></span>
  <span class="bg-rose-50 text-rose-700 border-rose-200"></span>
  <span class="bg-amber-50 text-amber-800 border-amber-200"></span>
  <span class="bg-indigo-50 text-indigo-700 border-indigo-200"></span>
</div>

<!-- Modal: Solicitar pago por correo -->
<div id="modal-pay-email" class="hidden fixed inset-0 z-40 flex items-center justify-center">
  <div class="absolute inset-0 bg-black/30"></div>
  <div class="relative bg-white w-full max-w-lg rounded-xl border shadow-md z-10">
    <div class="px-4 py-3 border-b flex items-center justify-between">
      <h3 class="font-medium">Solicitar pago por correo</h3>
      <button type="button" data-close="pay-email" class="px-2 py-1 rounded border bg-white">Cerrar</button>
    </div>
    <form id="form-pay-email" class="p-4 space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="block text-sm text-slate-600 mb-1">Email destino</label>
          <input name="email_to" type="email" required
                 value="{{ header.cliente_email or '' }}"
                 class="w-full border rounded-lg px-3 py-2">
        </div>
        <div>
          <label class="block text-sm text-slate-600 mb-1">Monto</label>
          <input name="monto" type="number" min="0" step="1" required
                 value="{{ header.total_neto or 0 }}"
                 class="w-full border rounded-lg px-3 py-2">
        </div>
        <div>
          <label class="block text-sm text-slate-600 mb-1">Moneda</label>
          <input name="moneda" value="{{ header.pago_moneda or 'CLP' }}"
                 class="w-full border rounded-lg px-3 py-2">
        </div>
      </div>
      <div>
        <label class="block text-sm text-slate-600 mb-1">Mensaje (opcional)</label>
        <textarea name="mensaje" rows="3" class="w-full border rounded-lg px-3 py-2"
                  placeholder="Instrucciones o un saludo para el cliente‚Ä¶"></textarea>
      </div>
      <div class="flex items-center justify-end gap-2">
        <button type="button" data-close="pay-email"
                class="px-3 py-2 rounded-lg border bg-white hover:bg-slate-50">Cancelar</button>
        <button id="btn-send-pay-email" type="submit"
                class="px-3 py-2 rounded-lg bg-slate-800 hover:bg-slate-900 text-white">Enviar</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal: Marcar como pagado -->
<div id="modal-pay-manual" class="hidden fixed inset-0 z-40 flex items-center justify-center">
  <div class="absolute inset-0 bg-black/30"></div>
  <div class="relative bg-white w-full max-w-2xl rounded-xl border shadow-md z-10">
    <div class="px-4 py-3 border-b flex items-center justify-between">
      <h3 class="font-medium">Marcar pedido como pagado</h3>
      <button type="button" data-close="pay-manual" class="px-2 py-1 rounded border bg-white">Cerrar</button>
    </div>
    <form id="form-pay-manual" class="p-4 space-y-4">
      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="block text-sm text-slate-600 mb-1">Forma de pago</label>
          <select name="forma_pago" required class="w-full border rounded-lg px-3 py-2">
            <option value="tarjeta">Tarjeta</option>
            <option value="transferencia">Transferencia</option>
            <option value="efectivo">Efectivo</option>
            <option value="otro">Otro</option>
          </select>
        </div>
        <div>
          <label class="block text-sm text-slate-600 mb-1">Medio de pago</label>
          <select name="medio_pago" required class="w-full border rounded-lg px-3 py-2">
            <option>Webpay</option>
            <option>MercadoPago</option>
            <option>Transferencia</option>
            <option>Caja/Local</option>
            <option>Otro</option>
          </select>
        </div>
        <div>
          <label class="block text-sm text-slate-600 mb-1">Proveedor (opcional)</label>
          <input name="proveedor" placeholder="Transbank / Banco / etc."
                 class="w-full border rounded-lg px-3 py-2">
        </div>
        <div>
          <label class="block text-sm text-slate-600 mb-1">Referencia (opcional)</label>
          <input name="ref_transaccion" placeholder="N¬∞ operaci√≥n / voucher"
                 class="w-full border rounded-lg px-3 py-2">
        </div>
        <div>
          <label class="block text-sm text-slate-600 mb-1">Monto</label>
          <input name="monto" type="number" min="0" step="1" required
                 value="{{ header.total_neto or 0 }}"
                 class="w-full border rounded-lg px-3 py-2">
        </div>
        <div>
          <label class="block text-sm text-slate-600 mb-1">Moneda</label>
          <input name="moneda" value="{{ header.pago_moneda or 'CLP' }}"
                 class="w-full border rounded-lg px-3 py-2">
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
        <div>
          <label class="block text-sm text-slate-600 mb-1">Nota para el cliente (opcional)</label>
          <textarea name="nota_cliente" rows="3" class="w-full border rounded-lg px-3 py-2"
                    placeholder="Mensaje visible al cliente‚Ä¶"></textarea>
        </div>
        <div>
          <label class="block text-sm text-slate-600 mb-1">Nota interna para el rol (opcional)</label>
          <textarea name="nota_interna" rows="3" class="w-full border rounded-lg px-3 py-2"
                    placeholder="Instrucciones para bodega/reparto/ventas‚Ä¶"></textarea>
          <div class="mt-2">
            <label class="block text-sm text-slate-600 mb-1">Rol destinatario (opcional)</label>
            <select name="destinatario_rol" class="w-full border rounded-lg px-3 py-2">
              <option value="">‚Äî Selecciona rol ‚Äî</option>
              <option value="bodega">Bodega</option>
              <option value="reparto">Reparto</option>
              <option value="ventas">Ventas</option>
              <option value="cliente">Cliente</option>
            </select>
          </div>
        </div>
      </div>

      <div class="flex items-center justify-end gap-2">
        <button type="button" data-close="pay-manual"
                class="px-3 py-2 rounded-lg border bg-white hover:bg-slate-50">Cancelar</button>
        <button id="btn-save-pay-manual" type="submit"
                class="px-3 py-2 rounded-lg bg-emerald-600 hover:bg-emerald-700 text-white">
          Guardar pago
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Modal Asignar transportista -->
<dialog id="modalAsignarTransportista" class="modal">
  <form method="post" action="/admin/pedidos/{{ header.id_pedido }}/asignar-transportista"
        class="modal-box space-y-4">
    <h3 class="font-semibold text-lg">Asignar transportista</h3>

    <label class="block text-sm">Transportista</label>
    <select name="id_transportista" class="w-full border rounded-xl p-2" required>
      {% for t in transportistas_activos %}
        <option value="{{ t.id_transportista }}">{{ t.nombre }} ‚Äî {{ t.rut }}</option>
      {% endfor %}
    </select>

    <label class="block text-sm mt-2">Tracking externo (opcional)</label>
    <input type="text" name="tracking_ext" class="w-full border rounded-xl p-2" placeholder="C√≥digo/URL de seguimiento">

    <label class="block text-sm mt-2">Observaci√≥n (opcional)</label>
    <textarea name="obs" class="w-full border rounded-xl p-2" rows="3"></textarea>

    <div class="modal-action">
      <button type="button" class="btn btn-ghost" onclick="this.closest('dialog').close()">Cancelar</button>
      <button class="btn btn-mint">Guardar</button>
    </div>
  </form>
</dialog>

<script>
(function () {
  const pedidoId = {{ header.id_pedido|int }};
  const $menuBtn = document.getElementById('btn-more-actions');
  const $menu    = document.getElementById('menu-more-actions');
  const $ddWrap  = document.getElementById('actions-dropdown');

  function toggleMenu(show) {
    if (!$menu) return;
    if (show) { $menu.classList.remove('hidden'); }
    else      { $menu.classList.add('hidden'); }
  }

  if ($menuBtn) {
    $menuBtn.addEventListener('click', function (e) {
      e.preventDefault();
      e.stopPropagation();
      toggleMenu($menu.classList.contains('hidden'));
    });
  }
  document.addEventListener('click', function (e) {
    if ($ddWrap && !$ddWrap.contains(e.target)) toggleMenu(false);
  });

  // Modales
  const modals = {
    label:     document.getElementById('modal-label'),
    estado:    document.getElementById('modal-estado'),
    payEmail:  document.getElementById('modal-pay-email'),
    payManual: document.getElementById('modal-pay-manual'),
  };

  // Diccionario "codigo -> nombre legible"
  const displayByCode = {
    {% for e in estados %}
    "{{ e.codigo|replace('\\','\\\\')|replace('"','\\"') }}": "{{ (e.nombre or (e.codigo|replace('_',' ')|title))|replace('\\','\\\\')|replace('"','\\"') }}"{% if not loop.last %},{% endif %}
    {% endfor %}
  };

  // Si el estado actual no viene en "estados", lo a√±adimos como fallback:
  {% set cod_actual = header.get('estado_codigo') or 'NUEVO' %}
  {% set nom_actual = header.get('estado_nombre') or (cod_actual|replace('_',' ')|title) %}
  if (!displayByCode["{{ cod_actual|replace('\\','\\\\')|replace('"','\\"') }}"]) {
    displayByCode["{{ cod_actual|replace('\\','\\\\')|replace('"','\\"') }}"] =
      "{{ nom_actual|replace('\\','\\\\')|replace('"','\\"') }}";
  }


  function openModal(name) {
    if (modals[name]) { modals[name].classList.remove('hidden'); }
  }
  function closeModal(name) {
    if (modals[name]) { modals[name].classList.add('hidden'); }
  }

  var closeLabelBtns = document.querySelectorAll('[data-close="label"]');
  closeLabelBtns.forEach(function (el) { el.addEventListener('click', function () { closeModal('label'); }); });

  var closeEstadoBtns = document.querySelectorAll('[data-close="estado"]');
  closeEstadoBtns.forEach(function (el) { el.addEventListener('click', function () { closeModal('estado'); }); });

  var closePayEmailBtns = document.querySelectorAll('[data-close="pay-email"]');
  closePayEmailBtns.forEach(function (el) { el.addEventListener('click', function () { closeModal('payEmail'); }); });

  var closePayManualBtns = document.querySelectorAll('[data-close="pay-manual"]');
  closePayManualBtns.forEach(function (el) { el.addEventListener('click', function () { closeModal('payManual'); }); });

  // Etiqueta
  var actImprimir = document.getElementById('act-imprimir');
  if (actImprimir) {
    actImprimir.addEventListener('click', function () {
      toggleMenu(false);
      var frame = document.getElementById('label-frame');
      var url = "/admin/pedidos/" + pedidoId + "/etiqueta";
      if (frame) {
        frame.src = url;
        openModal('label');
      }
    });
  }

  var btnPrintLabel = document.getElementById('btn-print-label');
  if (btnPrintLabel) {
    btnPrintLabel.addEventListener('click', function () {
      var f = document.getElementById('label-frame');
      try { if (f && f.contentWindow) { f.contentWindow.focus(); f.contentWindow.print(); } }
      catch (e) { console.error('[pedido-actions] print error', e); }
    });
  }

  // ===== Estado: helpers UI =====
  const estadoMap = {
    NUEVO:                ['border','bg-amber-50','text-amber-800','border-amber-200'],
    APROBADO_QF:          ['border','bg-sky-50','text-sky-700','border-sky-200'],
    APROBADO_CRITERIO_QF: ['border','bg-sky-50','text-sky-700','border-sky-200'],
    RECHAZADO_QF:         ['border','bg-rose-50','text-rose-700','border-rose-200'],
    EN_PREPARACION:       ['border','bg-indigo-50','text-indigo-700','border-indigo-200'],
    EN_TRANSITO:          ['border','bg-indigo-50','text-indigo-700','border-indigo-200'],
    ENTREGADO:            ['border','bg-green-50','text-green-700','border-green-200'],
    RECHAZADO_CLIENTE:    ['border','bg-rose-50','text-rose-700','border-rose-200'],
    PENDIENTE_PAGO:       ['border','bg-amber-50','text-amber-800','border-amber-200'],
  };

  function titleFromCode(code) {
    return (code || 'NUEVO').toString()
      .replace(/_/g,' ')
      .toLowerCase()
      .replace(/(^|\s)\S/g, function (s) { return s.toUpperCase(); });
  }

  function applyEstadoBadge(code) {
    var el = document.getElementById('badge-estado');
    if (!el) return;
    var all = [];
    for (var k in estadoMap) { if (Object.prototype.hasOwnProperty.call(estadoMap, k)) { all = all.concat(estadoMap[k]); } }
    all.forEach(function (c) { el.classList.remove(c); });

    var cls = estadoMap[(code || 'NUEVO').toUpperCase()] || estadoMap['NUEVO'];
    el.classList.add.apply(el.classList, cls);
    el.setAttribute('data-estado', code);
    el.textContent = displayByCode[code] || titleFromCode(code);
  }

  var badge = document.getElementById('badge-estado');
  applyEstadoBadge((badge && badge.dataset ? badge.dataset.estado : 'NUEVO') || 'NUEVO');

  // Abrir modal de estado
  var actEstado = document.getElementById('act-estado');
  if (actEstado) {
    actEstado.addEventListener('click', function () {
      toggleMenu(false);
      openModal('estado');
    });
  }

  // Guardar estado
  var formEstado = document.getElementById('form-estado');
  if (formEstado) {
    formEstado.addEventListener('submit', async function (e) {
      e.preventDefault();
      var fd = new FormData(formEstado);
      var btn = document.getElementById('btn-save-estado');
      if (btn) {
        btn.setAttribute('disabled', 'true');
        btn.classList.add('opacity-70','cursor-not-allowed');
        btn.textContent = 'Guardando‚Ä¶';
      }
      try {
        const resp = await fetch("/admin/pedidos/" + pedidoId + "/cambiar-estado", { method: 'POST', body: fd });
        const json = await resp.json().catch(function () { return {}; });
        if (json && json.ok) {
          applyEstadoBadge(json.nuevo_estado);
          closeModal('estado');
        } else {
          alert('No se pudo cambiar el estado: ' + ((json && json.error) || 'error desconocido'));
        }
      } catch (err) {
        console.error('[pedido-actions] fetch error', err);
        alert('Error de red al cambiar estado.');
      } finally {
        if (btn) {
          btn.removeAttribute('disabled');
          btn.classList.remove('opacity-70','cursor-not-allowed');
          btn.textContent = 'Guardar estado';
        }
      }
    });
  }

  // ===== Pagos (UI) =====
  var btnPayEmail = document.getElementById('btn-pay-email');
  if (btnPayEmail) btnPayEmail.addEventListener('click', function () { openModal('payEmail'); });

  var btnPayManual = document.getElementById('btn-pay-manual');
  if (btnPayManual) btnPayManual.addEventListener('click', function () { openModal('payManual'); });

  var formPayEmail = document.getElementById('form-pay-email');
  if (formPayEmail) {
    formPayEmail.addEventListener('submit', async function (e) {
      e.preventDefault();
      var fd = new FormData(formPayEmail);
      var btn = document.getElementById('btn-send-pay-email');
      if (btn) { btn.setAttribute('disabled','true'); btn.textContent = 'Enviando‚Ä¶'; }
      try {
        const resp = await fetch("/admin/pagos/" + pedidoId + "/enviar-solicitud", { method: 'POST', body: fd });
        const json = await resp.json().catch(function () { return {}; });
        if (json && json.ok) {
          closeModal('payEmail');
          alert('Solicitud de pago registrada.');
        } else {
          alert('No se pudo enviar: ' + ((json && json.error) || 'Error'));
        }
      } catch (err) {
        console.error('[pagos-ui] error', err);
        alert('Error de red.');
      } finally {
        if (btn) { btn.removeAttribute('disabled'); btn.textContent = 'Enviar'; }
      }
    });
  }

  var formPayManual = document.getElementById('form-pay-manual');
  if (formPayManual) {
    formPayManual.addEventListener('submit', async function (e) {
      e.preventDefault();
      var fd = new FormData(formPayManual);
      var btn = document.getElementById('btn-save-pay-manual');
      if (btn) { btn.setAttribute('disabled','true'); btn.textContent = 'Guardando‚Ä¶'; }
      try {
        const resp = await fetch("/admin/pagos/" + pedidoId + "/marcar-pagado", { method: 'POST', body: fd });
        const json = await resp.json().catch(function () { return {}; });
        if (json && json.ok) {
          closeModal('payManual');
          location.reload();
        } else {
          alert('No se pudo guardar: ' + ((json && json.error) || 'Error'));
        }
      } catch (err) {
        console.error('[pagos-ui] error', err);
        alert('Error de red.');
      } finally {
        if (btn) { btn.removeAttribute('disabled'); btn.textContent = 'Guardar pago'; }
      }
    });
  }
})();
</script>


{% endblock %}
