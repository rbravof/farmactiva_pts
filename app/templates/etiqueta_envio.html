<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <title>Etiqueta de Envío</title>
  <style>
    /* Tamaño exacto de impresión: 70mm ancho x 50mm alto */
    @page { size: 70mm 50mm; margin: 0; }

     /* En pantalla: encoger levemente para que quepa SIEMPRE sin scroll en el iframe */
    @media screen {
      html, body { width: 70mm; height: 50mm; overflow: hidden; }
      .label {
        width: 70mm; height: 50mm;
        /* Escala ligera: ajusta si quieres más/menos margen en el modal */
        transform: scale(0.92);
        transform-origin: top left;
      }
    }

    html, body { margin: 0; padding: 0; background: #fff; }
    * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }

    .label {
      width: 70mm; height: 50mm;
      box-sizing: border-box;
      padding: 3mm;                 /* margen interno compacto y nítido */
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      display: grid;
      grid-template-rows: auto 1fr auto;
      gap: 2mm;
      color: #111;
    }

    /* Encabezado */
    .row { display: flex; align-items: center; justify-content: space-between; }
    .logo { display: flex; align-items: center; gap: 4px; }
    .logo img { height: 9mm; width: auto; display: block; }
    .order { text-align: right; font-size: 10pt; font-weight: 700; line-height: 1.1; }
    .order small { display: block; font-size: 7pt; font-weight: 500; color: #444; }

    /* Cuerpo: dos columnas compactas */
    .box {
      border: 1px solid #000;      /* alto contraste para impresora térmica/láser */
      border-radius: 2px;
      padding: 2mm;
      height: 100%;
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 2mm;
    }
    .col { display: grid; gap: 1mm; min-width: 0; } /* min-width:0 para truncado correcto */
    .label-sm { font-size: 7pt; color: #333; }
    .value    { font-size: 9pt; font-weight: 700; line-height: 1.15; word-break: break-word; }

    /* Código de barras + pie */
    .foot { display: flex; align-items: center; justify-content: space-between; gap: 3mm; }
    .barcode { flex: 1; display: flex; align-items: center; justify-content: center; height: 12mm; }
    .barcode svg { width: 100%; height: 100%; }
    .pill { border: 1px solid #000; padding: 0.8mm 1.6mm; border-radius: 2px; font-size: 8pt; font-weight: 800; }

    /* No mostramos ningún botón auxiliar dentro del iframe/modal */
    .no-print { display: none !important; }

    @media print {
      .no-print { display: none !important; }
      body { background: #fff; }
    }
  </style>
</head>
<body>
  <div class="label">
    <!-- Encabezado -->
    <div class="row">
      <div class="logo">
        <img src="/static/images/logo/logo.png" alt="Farmactiva">
      </div>
      <div class="order">
        Pedido #{{ pedido.numero or pedido.id_pedido }}
        <small>{{ pedido.creado_en.strftime('%d-%m-%Y %H:%M') if pedido.creado_en else '' }}</small>
      </div>
    </div>

    <!-- Datos -->
    <div class="box">
      <div class="col">
        <div>
          <div class="label-sm">Cliente</div>
          <div class="value">{{ cliente.nombre or '—' }}</div>
        </div>
        <div>
          <div class="label-sm">Teléfono</div>
          <div class="value" style="font-weight:600">{{ cliente.telefono or '—' }}</div>
        </div>
      </div>
      <div class="col">
        <div>
          <div class="label-sm">Dirección</div>
          <div class="value" style="font-weight:700">
            {{ direccion.linea1 or '—' }}{% if direccion.linea2 %}, {{ direccion.linea2 }}{% endif %}<br>
            {{ direccion.comuna or '' }}{% if direccion.ciudad %}, {{ direccion.ciudad }}{% endif %}
          </div>
        </div>
        <div>
          <div class="label-sm">Observación</div>
          <div class="value" style="font-weight:600">{{ pedido.observacion_envio or '—' }}</div>
        </div>
      </div>
    </div>

    <!-- Código de barras / canal -->
    <div class="foot">
      <div style="flex:1">
        <div class="label-sm">Tracking interno</div>
        <div class="barcode"><svg id="barcode"></svg></div>
      </div>
      <div class="pill">{{ pedido.canal or 'WEB' }}</div>
    </div>
  </div>

  <!-- Generador Code128 -->
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
  <script>
    (function(){
      const code = {{ (etiqueta_codigo|tojson) if etiqueta_codigo is defined else ('""'|safe) }};
      try {
        // Altura optimizada para 70x50mm sin pixelado ni overflow
        JsBarcode("#barcode", code || "FA-"+(Date.now()), {
          format: "CODE128",
          displayValue: false,
          height: 40,  // px del SVG: cabe cómodo en 12mm de alto
          margin: 0
        });
      } catch(e) {
        console.error(e);
      }
    })();
  </script>
</body>
</html>
