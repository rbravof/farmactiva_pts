{% extends "base_admin.html" %}
{% block title %}Usuarios & Roles | Admin{% endblock %}

{% block content %}
<div class="bg-white border rounded-xl shadow p-5">
  <div class="flex items-center justify-between mb-4">
    <h1 class="text-xl font-semibold">Usuarios & Roles</h1>
    <a href="/admin/usuarios/nuevo" class="px-3 py-2 text-sm text-white bg-blue-600 rounded hover:bg-blue-700">
      Nuevo usuario
    </a>
  </div>

  <form method="get" class="mb-4 flex flex-wrap gap-2 items-end">
    <div>
      <label class="block text-xs text-gray-500">Buscar</label>
      <input type="text" name="q" value="{{ q }}" placeholder="rut, nombre, usuario..."
             class="border rounded px-3 py-2"/>
    </div>
    <div>
      <label class="block text-xs text-gray-500">Rol</label>
      <select name="rol" class="border rounded px-3 py-2">
        <option value="">Todos</option>
        <option value="admin" {{ 'selected' if rol=='admin' }}>Administrador</option>
        <option value="qf"    {{ 'selected' if rol=='qf' }}>Químico Farmacéutico</option>
        <option value="aux"   {{ 'selected' if rol=='aux' }}>Auxiliar</option>
        <option value="transportista" {{ 'selected' if rol=='transportista' }}>Transportista</option>
      </select>
    </div>
    <div>
      <label class="block text-xs text-gray-500">Estado</label>
      <select name="estado" class="border rounded px-3 py-2">
        <option value="all" {{ 'selected' if estado=='all' }}>Todos</option>
        <option value="activos" {{ 'selected' if estado=='activos' }}>Activos</option>
        <option value="inactivos" {{ 'selected' if estado=='inactivos' }}>Inactivos</option>
      </select>
    </div>
    <div>
      <button class="px-3 py-2 border rounded hover:bg-gray-50">Filtrar</button>
    </div>
  </form>

  <div class="overflow-auto">
    <table class="min-w-full text-sm">
      <thead>
        <tr class="text-left text-gray-500 border-b">
          <th class="py-2 pr-4">ID</th>
          <th class="py-2 pr-4">Usuario</th>
          <th class="py-2 pr-4">RUT</th>
          <th class="py-2 pr-4">Nombre</th>
          <th class="py-2 pr-4">Rol</th>
          <th class="py-2 pr-4">Estado</th>
          <th class="py-2 pr-4 text-right">Acciones</th>
        </tr>
      </thead>
      <tbody>
        {% for u in usuarios %}
        <tr class="border-b hover:bg-gray-50">
          <td class="py-2 pr-4">{{ u.id }}</td>
          <td class="py-2 pr-4 font-mono text-xs">{{ u.usuario }}</td>
          <td class="py-2 pr-4">{{ u.rut }}</td>
          <td class="py-2 pr-4">{{ u.nombre or '—' }}</td>
          <td class="py-2 pr-4">
            {% set label_map = {
              'admin':'Administrador',
              'qf':'QF',
              'aux':'Auxiliar',
              'transportista':'Transportista'
            } %}
            {% set style_map = {
              'admin':'bg-purple-100 text-purple-800',
              'qf':'bg-blue-100 text-blue-800',
              'aux':'bg-gray-100 text-gray-700',
              'transportista':'bg-amber-100 text-amber-800'
            } %}
            <span class="px-2 py-0.5 text-xs rounded font-medium {{ style_map.get(u.rol, 'bg-gray-100 text-gray-700') }}">
              {{ label_map.get(u.rol, (u.rol or '—')|capitalize) }}
            </span>
          </td>
          <td class="py-2 pr-4">
            {% if u.activo %}
              <span class="px-2 py-0.5 text-xs rounded bg-green-100 text-green-700">Activo</span>
            {% else %}
              <span class="px-2 py-0.5 text-xs rounded bg-red-100 text-red-700">Inactivo</span>
            {% endif %}
          </td>
          <td class="py-2 pr-4 text-right whitespace-nowrap">
            <a href="/admin/usuarios/{{ u.id }}/editar" class="px-2 py-1 text-xs border rounded hover:bg-gray-50">Editar</a>
            <form action="/admin/usuarios/{{ u.id }}/toggle" method="post" class="inline">
              <button class="px-2 py-1 text-xs border rounded hover:bg-gray-50" type="submit">
                {{ 'Desactivar' if u.activo else 'Activar' }}
              </button>
            </form>
            <form action="/admin/usuarios/{{ u.id }}/reset" method="post" class="inline">
              <button class="px-2 py-1 text-xs border rounded hover:bg-gray-50" type="submit" title="Reset clave">
                Reset clave
              </button>
            </form>
          </td>
        </tr>
        {% else %}
        <tr><td colspan="7" class="py-6 text-center text-gray-500">No hay usuarios.</td></tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
